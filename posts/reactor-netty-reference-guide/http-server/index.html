<!DOCTYPE html>
<html lang="zh"><meta charset="utf-8"><meta name="generator" content="Hugo 0.81.0" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="color-scheme" content="light dark">
<meta name="supported-color-schemes" content="light dark"><title>Reactor Netty参考指南 - 5.HTTP服务端&nbsp;&ndash;&nbsp;Immuthex的博客</title><meta name="keywords" content="Reactor Netty,Reactor Netty中文文档,Reactor Netty参考指南" /><meta name="description" content="Reactor Netty参考指南第五章（HTTP服务端）中文翻译" /><link rel="stylesheet" href="/css/core.min.615fa51c37c342f9111f46db696ab299cb089e23d2925a922a047a7a740f5f2e314b9888c9db5136fcdc211089b9dfa6.css" integrity="sha384-YV&#43;lHDfDQvkRH0bbaWqymcsIniPSklqSKgR6enQPXy4xS5iIydtRNvzcIRCJud&#43;m"><meta name="twitter:card" content="summary" />
<meta name="twitter:title" content="Reactor Netty参考指南 - 5.HTTP服务端" /><body><section id="header">
    <div class="header wrap"><span class="header left-side"><a class="site home" href="/"><span class="site name">Immuthex的博客</span></a></span>
        <span class="header right-side"><div class="nav wrap">
    <nav class="nav"><a class="nav item" href="/categories/">分类</a><a class="nav item" href="/tags/">标签</a><a class="nav item" href="https://github.com/immuthex" target="_blank" one-link-mark="yes"><span
                class="iconfont icon-github"></span>&nbsp;Github</a>
    </nav>
</div></span></div></section><section id="content"><div class="article-container"><section class="article header">
    <h1 class="article title">Reactor Netty参考指南 - 5.HTTP服务端</h1><p class="article date">2021-03-10</p></section><article class="article markdown-body"><p>Reactor Netty参考指南第五章（HTTP服务端）中文翻译</p>
<h2 id="reactor-netty参考指南目录contents"><a href="../contents">Reactor Netty参考指南目录</a>
</h2>
<hr>
<h1 id="原文地址httpsprojectreactoriodocsnettyreleasereferenceindexhtmlhttp-server"><a href="https://projectreactor.io/docs/netty/release/reference/index.html#http-server"target="_blank" rel="noopener noreferrer">原文地址</a>
</h1>
<p><code>Reactor Netty</code>提供了易于使用和配置的<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServer.html"target="_blank" rel="noopener noreferrer"><code>HttpServer</code></a>
。它隐藏了创建<code>HTTP</code>服务器所需的大部分<code>Netty</code>的功能，并增加了<code>Reactive Streams</code>背压。</p>
<h1 id="51启动和停止">5.1.启动和停止</h1>
<p>要想启动一个HTTP服务器，您必须创建并且配置一个<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServer.html"target="_blank" rel="noopener noreferrer"><code>HttpServer</code></a>
实例。默认情况下，<code>host</code>被配置为任何的本地地址，当执行<code>bind</code>操作的时候系统会选择一个临时端口。下面是创建并且配置一个<code>HttpServer</code>实例的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/create/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/create/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>   <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span> <span style="color:#75715e">//&lt;2&gt;
</span><span style="color:#75715e"></span>
		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 创建一个<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServer.html"target="_blank" rel="noopener noreferrer"><code>HttpServer</code></a>
实例用来进行之后的配置操作。</p>
<p>&lt;2&gt; 使用阻塞等待的方式启动服务器，直到初始化完成。</p>
</blockquote>
<p>返回的<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/DisposableServer.html"target="_blank" rel="noopener noreferrer"><code>DisposableServer</code></a>
提供了简单的服务器API，包括<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/DisposableChannel.html#disposeNow-java.time.Duration-"target="_blank" rel="noopener noreferrer"><code>disposeNow()</code></a>
，这个方法可以以阻塞等待的方式来关闭服务器。</p>
<h2 id="511host和port">5.1.1.Host和Port</h2>
<p>想要设置特定<code>host</code>和<code>port</code>，您可以用下面的方式来配置<code>HTTP</code>服务器：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/address/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/address/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">host</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;localhost&#34;</span><span style="color:#f92672">)</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">port</span><span style="color:#f92672">(</span>8080<span style="color:#f92672">)</span>        <span style="color:#75715e">//&lt;2&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 配置<code>HTTP</code>服务器的host</p>
<p>&lt;2&gt; 配置<code>HTTP</code>服务器的port</p>
</blockquote>
<h1 id="52预先初始化">5.2.预先初始化</h1>
<p>默认情况下，<code>HttpServer</code>初始化资源的操作在需要使用的时候才进行。这意味着初始化加载的时候<code>bind operation</code>会占用额外的时间：</p>
<ul>
<li>事件循环组</li>
<li>native传输库（当使用了native传输的时候）</li>
<li>用于安全性的native库（使用了<code>OpenSsl</code>的时候）</li>
</ul>
<p>当您需要预加载这些资源的时候，您可以按照以下方式来配置<code>HttpServer</code>：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/warmup/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/warmup/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		HttpServer httpServer <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">handle</span><span style="color:#f92672">((</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">receive</span><span style="color:#f92672">().</span><span style="color:#a6e22e">then</span><span style="color:#f92672">());</span>

		httpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">warmup</span><span style="color:#f92672">()</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>		          <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>

		DisposableServer server <span style="color:#f92672">=</span> httpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 初始化和加载事件循环组，native传输库和用于安全性的native库</p>
</blockquote>
<h1 id="53http路由">5.3.HTTP路由</h1>
<p>想要给<code>HTTP</code>服务器定义路由需要配置提供的<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServerRoutes.html"target="_blank" rel="noopener noreferrer"><code>HttpServerRoutes</code></a>
 builder。示例如下：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/routing/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/routing/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">route</span><span style="color:#f92672">(</span>routes <span style="color:#f92672">-&gt;</span>
				              routes<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">,</span>        <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				                        <span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello World!&#34;</span><span style="color:#f92672">)))</span>
				                    <span style="color:#f92672">.</span><span style="color:#a6e22e">post</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/echo&#34;</span><span style="color:#f92672">,</span>        <span style="color:#75715e">//&lt;2&gt;
</span><span style="color:#75715e"></span>				                        <span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">receive</span><span style="color:#f92672">().</span><span style="color:#a6e22e">retain</span><span style="color:#f92672">()))</span>
				                    <span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/path/{param}&#34;</span><span style="color:#f92672">,</span> <span style="color:#75715e">//&lt;3&gt;
</span><span style="color:#75715e"></span>				                        <span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;param&#34;</span><span style="color:#f92672">))))</span>
				                    <span style="color:#f92672">.</span><span style="color:#a6e22e">ws</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/ws&#34;</span><span style="color:#f92672">,</span>            <span style="color:#75715e">//&lt;4&gt;
</span><span style="color:#75715e"></span>				                        <span style="color:#f92672">(</span>wsInbound<span style="color:#f92672">,</span> wsOutbound<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> wsOutbound<span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>wsInbound<span style="color:#f92672">.</span><span style="color:#a6e22e">receive</span><span style="color:#f92672">().</span><span style="color:#a6e22e">retain</span><span style="color:#f92672">())))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 提供一个为<code>/hello</code>的<code>GET</code>路由，返回<code>Hello World!</code>字符串</p>
<p>&lt;2&gt; 提供一个为<code>/echo</code>的<code>POST</code>路由，将接收到的请求的body数据返回回去。</p>
<p>&lt;3&gt; 提供一个为<code>/path/{param}</code>的<code>GET</code>路由，返回路径参数的值。</p>
<p>&lt;4&gt; 提供一个websocket的<code>/ws</code>路由，将接收到的数据返回回去。</p>
</blockquote>
<blockquote>
<p>服务器路由是唯一的，并且按照声明的顺序第一个匹配上的才会被调用。</p>
</blockquote>
<h2 id="531sse">5.3.1.SSE</h2>
<p>下面的代码展示了如何配置<code>HTTP</code>服务器来提供<code>Server-Sent Events</code>服务：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/sse/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/sse/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> com.fasterxml.jackson.databind.ObjectMapper<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> io.netty.buffer.ByteBuf<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> io.netty.buffer.ByteBufAllocator<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> org.reactivestreams.Publisher<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.core.publisher.Flux<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServerRequest<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServerResponse<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.io.ByteArrayOutputStream<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.charset.Charset<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.time.Duration<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.util.function.BiFunction<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">route</span><span style="color:#f92672">(</span>routes <span style="color:#f92672">-&gt;</span> routes<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/sse&#34;</span><span style="color:#f92672">,</span> serveSse<span style="color:#f92672">()))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>

	<span style="color:#75715e">/**
</span><span style="color:#75715e">	 * Prepares SSE response
</span><span style="color:#75715e">	 * The &#34;Content-Type&#34; is &#34;text/event-stream&#34;
</span><span style="color:#75715e">	 * The flushing strategy is &#34;flush after every element&#34; emitted by the provided Publisher
</span><span style="color:#75715e">	 */</span>
	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> BiFunction<span style="color:#f92672">&lt;</span>HttpServerRequest<span style="color:#f92672">,</span> HttpServerResponse<span style="color:#f92672">,</span> Publisher<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">serveSse</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
		Flux<span style="color:#f92672">&lt;</span>Long<span style="color:#f92672">&gt;</span> flux <span style="color:#f92672">=</span> Flux<span style="color:#f92672">.</span><span style="color:#a6e22e">interval</span><span style="color:#f92672">(</span>Duration<span style="color:#f92672">.</span><span style="color:#a6e22e">ofSeconds</span><span style="color:#f92672">(</span>10<span style="color:#f92672">));</span>
		<span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
		        response<span style="color:#f92672">.</span><span style="color:#a6e22e">sse</span><span style="color:#f92672">()</span>
		                <span style="color:#f92672">.</span><span style="color:#a6e22e">send</span><span style="color:#f92672">(</span>flux<span style="color:#f92672">.</span><span style="color:#a6e22e">map</span><span style="color:#f92672">(</span>Application<span style="color:#f92672">::</span>toByteBuf<span style="color:#f92672">),</span> b <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
	<span style="color:#f92672">}</span>

	<span style="color:#75715e">/**
</span><span style="color:#75715e">	 * Transforms the Object to ByteBuf following the expected SSE format.
</span><span style="color:#75715e">	 */</span>
	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> ByteBuf <span style="color:#a6e22e">toByteBuf</span><span style="color:#f92672">(</span>Object any<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		ByteArrayOutputStream out <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ByteArrayOutputStream<span style="color:#f92672">();</span>
		<span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
			out<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;data: &#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span>Charset<span style="color:#f92672">.</span><span style="color:#a6e22e">defaultCharset</span><span style="color:#f92672">()));</span>
			MAPPER<span style="color:#f92672">.</span><span style="color:#a6e22e">writeValue</span><span style="color:#f92672">(</span>out<span style="color:#f92672">,</span> any<span style="color:#f92672">);</span>
			out<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;\n\n&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getBytes</span><span style="color:#f92672">(</span>Charset<span style="color:#f92672">.</span><span style="color:#a6e22e">defaultCharset</span><span style="color:#f92672">()));</span>
		<span style="color:#f92672">}</span>
		<span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
			<span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
		<span style="color:#f92672">}</span>
		<span style="color:#66d9ef">return</span> ByteBufAllocator<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT</span>
		                       <span style="color:#f92672">.</span><span style="color:#a6e22e">buffer</span><span style="color:#f92672">()</span>
		                       <span style="color:#f92672">.</span><span style="color:#a6e22e">writeBytes</span><span style="color:#f92672">(</span>out<span style="color:#f92672">.</span><span style="color:#a6e22e">toByteArray</span><span style="color:#f92672">());</span>
	<span style="color:#f92672">}</span>

	<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> ObjectMapper MAPPER <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ObjectMapper<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<h2 id="532静态资源">5.3.2.静态资源</h2>
<p>下面的代码展示了怎么配置<code>HTTP</code>服务器来提供静态资源：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/staticresources/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/staticresources/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.net.URISyntaxException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.file.Path<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.file.Paths<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> URISyntaxException <span style="color:#f92672">{</span>
		Path file <span style="color:#f92672">=</span> Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>Application<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/logback.xml&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">toURI</span><span style="color:#f92672">());</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">route</span><span style="color:#f92672">(</span>routes <span style="color:#f92672">-&gt;</span> routes<span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/index.html&#34;</span><span style="color:#f92672">,</span> file<span style="color:#f92672">))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<h1 id="54写出数据">5.4.写出数据</h1>
<p>如果要发送数据到一个已连接的客户端，您必须使用<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServer.html#handle-java.util.function.BiFunction-"target="_blank" rel="noopener noreferrer"><code>handler(…)</code></a>
或者<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServer.html#route-java.util.function.Consumer-"target="_blank" rel="noopener noreferrer"><code>route(…)</code></a>
来添加一个I/O处理器。这个I/O处理器可以通过<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServerResponse.html"target="_blank" rel="noopener noreferrer"><code>HttpServerResponse</code></a>
来写出数据。下面是使用<code>handle(…)</code>方法的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/send/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/send/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">handle</span><span style="color:#f92672">((</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">)))</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 给已连接的客户端发送<code>hello</code>字符串</p>
</blockquote>
<h2 id="541添加headers或其他元数据">5.4.1.添加Headers或其他元数据</h2>
<p>当您给已连接的客户端发送数据的时候，您可能想发送额外的headers,cookies,status code和其他的元数据。您可以使用<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServerResponse.html"target="_blank" rel="noopener noreferrer"><code>HttpServerResponse</code></a>
来添加这些额外的元数据。示例如下：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/send/headers/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/send/headers/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> io.netty.handler.codec.http.HttpHeaderNames<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> io.netty.handler.codec.http.HttpResponseStatus<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">route</span><span style="color:#f92672">(</span>routes <span style="color:#f92672">-&gt;</span>
				              routes<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/hello&#34;</span><span style="color:#f92672">,</span>
				                  <span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
				                      response<span style="color:#f92672">.</span><span style="color:#a6e22e">status</span><span style="color:#f92672">(</span>HttpResponseStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">OK</span><span style="color:#f92672">)</span>
				                              <span style="color:#f92672">.</span><span style="color:#a6e22e">header</span><span style="color:#f92672">(</span>HttpHeaderNames<span style="color:#f92672">.</span><span style="color:#a6e22e">CONTENT_LENGTH</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;12&#34;</span><span style="color:#f92672">)</span>
				                              <span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Hello World!&#34;</span><span style="color:#f92672">))))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<h2 id="542压缩">5.4.2.压缩</h2>
<p>您可以通过配置<code>HTTP</code>服务器，根据请求头<code>Accept-Encoding</code>来返回一个压缩的响应体。</p>
<p><code>Reactor Netty</code>提供了三种不同的策略来压缩传出的数据：</p>
<ul>
<li><code>compress(boolean)</code>：根据所提供的布尔值，<code>true</code>为启用压缩，<code>false</code>为禁用压缩。</li>
<li><code>compress(int)</code>：当响应体大小超过了给定的值就会将响应体进行压缩（单位：字节）。</li>
<li><code>compress(BiPredicate&lt;HttpServerRequest, HttpServerResponse&gt;)</code>：如果predicate返回<code>true</code>则压缩。</li>
</ul>
<p>下面的是使用<code>compress</code>方法（设置为<code>true</code>）来启用压缩的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/compression/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/compression/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.net.URISyntaxException<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.file.Path<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.nio.file.Paths<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> URISyntaxException <span style="color:#f92672">{</span>
		Path file <span style="color:#f92672">=</span> Paths<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>Application<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getResource</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/logback.xml&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">toURI</span><span style="color:#f92672">());</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">compress</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">route</span><span style="color:#f92672">(</span>routes <span style="color:#f92672">-&gt;</span> routes<span style="color:#f92672">.</span><span style="color:#a6e22e">file</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/index.html&#34;</span><span style="color:#f92672">,</span> file<span style="color:#f92672">))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<h1 id="55消费数据">5.5.消费数据</h1>
<p>如果要接收从连接的客户端发过来的数据，您必须使用<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServer.html#handle-java.util.function.BiFunction-"target="_blank" rel="noopener noreferrer"><code>handler(…)</code></a>
或者<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServer.html#route-java.util.function.Consumer-"target="_blank" rel="noopener noreferrer"><code>route(…)</code></a>
来添加一个I/O处理器。这个I/O处理器可以通过<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServerRequest.html"target="_blank" rel="noopener noreferrer"><code>HttpServerRequest</code></a>
来读数据。</p>
<p>下面是使用<code>handle(…)</code>方法的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/read/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/read/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">handle</span><span style="color:#f92672">((</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">receive</span><span style="color:#f92672">().</span><span style="color:#a6e22e">then</span><span style="color:#f92672">())</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 接收从已连接的客户端发过来的数据</p>
</blockquote>
<h2 id="551读取headersuri参数和其他元数据">5.5.1.读取Headers,URI参数和其他元数据</h2>
<p>当您从已连接的客户端接收数据的时候，您可能需要检查请求头，参数和其他的元数据。您可以通过<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServerRequest.html"target="_blank" rel="noopener noreferrer"><code>HttpServerRequest</code></a>
来获取这些元数据。示例如下：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/read/headers/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/read/headers/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">route</span><span style="color:#f92672">(</span>routes <span style="color:#f92672">-&gt;</span>
				              routes<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/{param}&#34;</span><span style="color:#f92672">,</span>
				                  <span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
				                      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">requestHeaders</span><span style="color:#f92672">().</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Some-Header&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
				                          <span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;param&#34;</span><span style="color:#f92672">)));</span>
				                      <span style="color:#f92672">}</span>
				                      <span style="color:#66d9ef">return</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendNotFound</span><span style="color:#f92672">();</span>
				                  <span style="color:#f92672">}))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<h3 id="获取远程客户端地址">获取远程（客户端）地址</h3>
<p>您可以从请求数据中获取的额外的元数据，您也可以拿到<code>host(server)</code>的地址，<code>remote(client)</code>的地址和<code>schema</code>。根据选择的工厂方法，您可以直接从channel拿到这些信息或者从<code>Forwarded</code>或者<code>X-Forwarded-* HTTP</code>请求头中拿到这些信息。示例如下：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/clientaddress/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/clientaddress/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">forwarded</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">route</span><span style="color:#f92672">(</span>routes <span style="color:#f92672">-&gt;</span>
				              routes<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/clientip&#34;</span><span style="color:#f92672">,</span>
				                  <span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
				                      response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">remoteAddress</span><span style="color:#f92672">()</span> <span style="color:#75715e">//&lt;2&gt;
</span><span style="color:#75715e"></span>				                                                           <span style="color:#f92672">.</span><span style="color:#a6e22e">getHostString</span><span style="color:#f92672">()))))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 如果可能的话，从Forwarded和X-Forwarded-* HTTP请求头中获取连接的相关信息。</p>
<p>&lt;2&gt; 从远（客户端）端返回地址。</p>
</blockquote>
<p>也可以自定义<code>Forwarded</code>或<code>X-Forwarded-*</code>头处理器。下面的例子展示怎么做：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/clientaddress/CustomForwardedHeaderHandlerApplication.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/clientaddress/CustomForwardedHeaderHandlerApplication.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> java.net.InetSocketAddress<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.transport.AddressUtils<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomForwardedHeaderHandlerApplication</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">forwarded</span><span style="color:#f92672">((</span>connectionInfo<span style="color:#f92672">,</span> request<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>  <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				              String hostHeader <span style="color:#f92672">=</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">headers</span><span style="color:#f92672">().</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;X-Forwarded-Host&#34;</span><span style="color:#f92672">);</span>
				              <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>hostHeader <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
				                  String<span style="color:#f92672">[]</span> hosts <span style="color:#f92672">=</span> hostHeader<span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;,&#34;</span><span style="color:#f92672">,</span> 2<span style="color:#f92672">);</span>
				                  InetSocketAddress hostAddress <span style="color:#f92672">=</span> AddressUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">createUnresolved</span><span style="color:#f92672">(</span>
				                      hosts<span style="color:#f92672">[</span>hosts<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">-</span> 1<span style="color:#f92672">].</span><span style="color:#a6e22e">trim</span><span style="color:#f92672">(),</span>
				                      connectionInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">getHostAddress</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getPort</span><span style="color:#f92672">());</span>
				                  connectionInfo <span style="color:#f92672">=</span> connectionInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">withHostAddress</span><span style="color:#f92672">(</span>hostAddress<span style="color:#f92672">);</span>
				              <span style="color:#f92672">}</span>
				              <span style="color:#66d9ef">return</span> connectionInfo<span style="color:#f92672">;</span>
				          <span style="color:#f92672">})</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">route</span><span style="color:#f92672">(</span>routes <span style="color:#f92672">-&gt;</span>
				              routes<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/clientip&#34;</span><span style="color:#f92672">,</span>
				                  <span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
				                      response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>request<span style="color:#f92672">.</span><span style="color:#a6e22e">remoteAddress</span><span style="color:#f92672">()</span> <span style="color:#75715e">//&lt;2&gt;
</span><span style="color:#75715e"></span>				                                                           <span style="color:#f92672">.</span><span style="color:#a6e22e">getHostString</span><span style="color:#f92672">()))))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 添加一个自定义头处理器。</p>
<p>&lt;2&gt; 从远（客户端）端返回地址。</p>
</blockquote>
<h2 id="552http请求解码器">5.5.2.HTTP请求解码器</h2>
<p>默认情况下，<code>Netty</code>对收到的请求配置了一些限制条件，例如：</p>
<ul>
<li>
<p>初始行的最大长度。</p>
</li>
<li>
<p>所有头的最大长度。</p>
</li>
<li>
<p>content或每个chunk的最大长度。</p>
</li>
</ul>
<p>更多的信息请查看<a href="https://netty.io/4.1/api/io/netty/handler/codec/http/HttpRequestDecoder.html"target="_blank" rel="noopener noreferrer"><code>HttpRequestDecoder</code></a>
和<a href="https://netty.io/4.1/api/io/netty/handler/codec/http/HttpServerUpgradeHandler.html"target="_blank" rel="noopener noreferrer"><code>HttpServerUpgradeHandler</code></a>
</p>
<p>默认情况下，<code>HTTP</code>服务器配置如下：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-http/src/main/java/reactor/netty/http/HttpDecoderSpec.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-http/src/main/java/reactor/netty/http/HttpDecoderSpec.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DEFAULT_MAX_INITIAL_LINE_LENGTH <span style="color:#f92672">=</span> 4096<span style="color:#f92672">;</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DEFAULT_MAX_HEADER_SIZE         <span style="color:#f92672">=</span> 8192<span style="color:#f92672">;</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DEFAULT_MAX_CHUNK_SIZE          <span style="color:#f92672">=</span> 8192<span style="color:#f92672">;</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">boolean</span> DEFAULT_VALIDATE_HEADERS    <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DEFAULT_INITIAL_BUFFER_SIZE     <span style="color:#f92672">=</span> 128<span style="color:#f92672">;</span>
</code></pre></div></blockquote>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-http/src/main/java/reactor/netty/http/server/HttpRequestDecoderSpec.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-http/src/main/java/reactor/netty/http/server/HttpRequestDecoderSpec.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/**
</span><span style="color:#75715e"> * The maximum length of the content of the HTTP/2.0 clear-text upgrade request.
</span><span style="color:#75715e"> * By default the server will reject an upgrade request with non-empty content,
</span><span style="color:#75715e"> * because the upgrade request is most likely a GET request.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">int</span> DEFAULT_H2C_MAX_CONTENT_LENGTH <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
</code></pre></div></blockquote>
<p>当您需要改变这些配置的时候，您可以通过如下方式配置<code>HTTP</code>服务器：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/requestdecoder/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/requestdecoder/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">httpRequestDecoder</span><span style="color:#f92672">(</span>spec <span style="color:#f92672">-&gt;</span> spec<span style="color:#f92672">.</span><span style="color:#a6e22e">maxHeaderSize</span><span style="color:#f92672">(</span>16384<span style="color:#f92672">))</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">handle</span><span style="color:#f92672">((</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">)))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 全部头的最大长度为<code>16384</code>。当超过这个值的时候会引发<a href="https://netty.io/4.1/api/io/netty/handler/codec/TooLongFrameException.html"target="_blank" rel="noopener noreferrer">TooLongFrameException</a>
。</p>
</blockquote>
<h1 id="56生命周期回调">5.6.生命周期回调</h1>
<p>下面的生命周期回调用参数是提供给您用来扩展<code>HttpServer</code>的：</p>
<table>
<thead>
<tr>
<th>Callback</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>doOnBind</code></td>
<td>当服务器channel即将被绑定的时候调用。</td>
</tr>
<tr>
<td><code>doOnBound</code></td>
<td>当服务器channel已经被绑定的时候调用。</td>
</tr>
<tr>
<td><code>doOnChannelInit</code></td>
<td>当channel初始化的时候被调用。</td>
</tr>
<tr>
<td><code>doOnConnection</code></td>
<td>当一个远程客户端连接上的时候被调用。</td>
</tr>
<tr>
<td><code>doOnUnbound</code></td>
<td>当服务器channel解绑的时候被调用。</td>
</tr>
</tbody>
</table>
<p>下面是使用<code>doOnConnection</code>和<code>doOnChannelInit</code>回调的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/lifecycle/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/lifecycle/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> io.netty.handler.logging.LoggingHandler<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> io.netty.handler.timeout.ReadTimeoutHandler<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.util.concurrent.TimeUnit<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">doOnConnection</span><span style="color:#f92672">(</span>conn <span style="color:#f92672">-&gt;</span>
				              conn<span style="color:#f92672">.</span><span style="color:#a6e22e">addHandler</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> ReadTimeoutHandler<span style="color:#f92672">(</span>10<span style="color:#f92672">,</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">)))</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">doOnChannelInit</span><span style="color:#f92672">((</span>observer<span style="color:#f92672">,</span> channel<span style="color:#f92672">,</span> remoteAddress<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
				              channel<span style="color:#f92672">.</span><span style="color:#a6e22e">pipeline</span><span style="color:#f92672">()</span>
				                     <span style="color:#f92672">.</span><span style="color:#a6e22e">addFirst</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> LoggingHandler<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;reactor.netty.examples&#34;</span><span style="color:#f92672">)))</span> <span style="color:#75715e">//&lt;2&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 当一个远程客户端连接的时候添加了一个<code>ReadTimeoutHandler</code>到<code>Netty</code> pipeline。</p>
<p>&lt;2&gt; 当初始化channel的时候添加了一个<code>LoggingHandler</code>到<code>Netty</code> pipeline。</p>
</blockquote>
<h1 id="57tcp层的配置">5.7.TCP层的配置</h1>
<p>当您需要修改TCP层的配置的时候，您可以使用以下代码段来扩展默认的<code>TCP</code>服务器配置：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/channeloptions/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/channeloptions/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> io.netty.channel.ChannelOption<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">option</span><span style="color:#f92672">(</span>ChannelOption<span style="color:#f92672">.</span><span style="color:#a6e22e">CONNECT_TIMEOUT_MILLIS</span><span style="color:#f92672">,</span> 10000<span style="color:#f92672">)</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<p>关于TCP层配置的更多详情请查看<a href="https://projectreactor.io/docs/netty/release/reference/index.html#tcp-server"target="_blank" rel="noopener noreferrer">TCP Server</a>
。</p>
<h2 id="571wire-logger">5.7.1.Wire Logger</h2>
<p>Reactor Netty提供了线路记录（wire logging）用来检查点对点的流量。默认情况下，线路记录是关闭的。如果想要开启它，您必须将日志<code>reactor.netty.http.server.HttpServer</code>的设置为<code>DEBUG</code>等级并且按如下方式进行配置：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/wiretap/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/wiretap/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">wiretap</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 开启线路记录</p>
</blockquote>
<p>默认情况下，线路记录在输出内容的时候会使用<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/transport/logging/AdvancedByteBufFormat.html#HEX_DUMP"target="_blank" rel="noopener noreferrer">AdvancedByteBufFormat#HEX_DUMP</a>
。您也可以通过配置<code>HttpServer</code>改为<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/transport/logging/AdvancedByteBufFormat.html#SIMPLE"target="_blank" rel="noopener noreferrer">AdvancedByteBufFormat#SIMPLE</a>
或者<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/transport/logging/AdvancedByteBufFormat.html#TEXTUAL"target="_blank" rel="noopener noreferrer">AdvancedByteBufFormat#TEXTUAL</a>
：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/wiretap/custom/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/wiretap/custom/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> io.netty.handler.logging.LogLevel<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.transport.logging.AdvancedByteBufFormat<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">wiretap</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;logger-name&#34;</span><span style="color:#f92672">,</span> LogLevel<span style="color:#f92672">.</span><span style="color:#a6e22e">DEBUG</span><span style="color:#f92672">,</span> AdvancedByteBufFormat<span style="color:#f92672">.</span><span style="color:#a6e22e">TEXTUAL</span><span style="color:#f92672">)</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 开启线路记录并使用<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/transport/logging/AdvancedByteBufFormat.html#TEXTUAL"target="_blank" rel="noopener noreferrer">AdvancedByteBufFormat#TEXTUAL</a>
来输出内容。</p>
</blockquote>
<h1 id="58ssl和tls">5.8.SSL和TLS</h1>
<p>当您需要使用SSL或者TLS的时候，可以使用下面列出来方式进行配置。默认情况下，如果<code>OpenSSL</code>可用的话，则使用<a href="https://netty.io/4.1/api/io/netty/handler/ssl/SslProvider.html#OPENSSL"target="_blank" rel="noopener noreferrer"><code>SslProvider.OPENSSL</code></a>
。否则使用<a href="https://netty.io/4.1/api/io/netty/handler/ssl/SslProvider.html#JDK"target="_blank" rel="noopener noreferrer"><code>SslProvider.JDK</code></a>
。可以通过<a href="https://netty.io/4.1/api/io/netty/handler/ssl/SslContextBuilder.html#sslProvider-io.netty.handler.ssl.SslProvider-"target="_blank" rel="noopener noreferrer"><code>SslContextBuilder</code></a>
或者设置<code>-Dio.netty.handler.ssl.noOpenSsl=true</code>来进行切换。</p>
<p>下面的是使用<code>SslContextBuilder</code>的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/security/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/security/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> io.netty.handler.ssl.SslContextBuilder<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.io.File<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		File cert <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;certificate.crt&#34;</span><span style="color:#f92672">);</span>
		File key <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;private.key&#34;</span><span style="color:#f92672">);</span>

		SslContextBuilder sslContextBuilder <span style="color:#f92672">=</span> SslContextBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">forServer</span><span style="color:#f92672">(</span>cert<span style="color:#f92672">,</span> key<span style="color:#f92672">);</span>

		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">secure</span><span style="color:#f92672">(</span>spec <span style="color:#f92672">-&gt;</span> spec<span style="color:#f92672">.</span><span style="color:#a6e22e">sslContext</span><span style="color:#f92672">(</span>sslContextBuilder<span style="color:#f92672">))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<h2 id="581服务器名称标识">5.8.1.服务器名称标识</h2>
<p>您可以配置<code>HTTP</code>服务器的多个<code>SslContext</code>映射到一个特定的域。配置<code>SNI</code>映射时，可以使用确切的域名或包含通配符的域名。</p>
<p>下面是使用包含通配符的域名的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/sni/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/sni/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> io.netty.handler.ssl.SslContext<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> io.netty.handler.ssl.SslContextBuilder<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.io.File<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> Exception <span style="color:#f92672">{</span>
		File defaultCert <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;default_certificate.crt&#34;</span><span style="color:#f92672">);</span>
		File defaultKey <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;default_private.key&#34;</span><span style="color:#f92672">);</span>

		File testDomainCert <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;default_certificate.crt&#34;</span><span style="color:#f92672">);</span>
		File testDomainKey <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;default_private.key&#34;</span><span style="color:#f92672">);</span>

		SslContext defaultSslContext <span style="color:#f92672">=</span> SslContextBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">forServer</span><span style="color:#f92672">(</span>defaultCert<span style="color:#f92672">,</span> defaultKey<span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>
		SslContext testDomainSslContext <span style="color:#f92672">=</span> SslContextBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">forServer</span><span style="color:#f92672">(</span>testDomainCert<span style="color:#f92672">,</span> testDomainKey<span style="color:#f92672">).</span><span style="color:#a6e22e">build</span><span style="color:#f92672">();</span>

		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">secure</span><span style="color:#f92672">(</span>spec <span style="color:#f92672">-&gt;</span> spec<span style="color:#f92672">.</span><span style="color:#a6e22e">sslContext</span><span style="color:#f92672">(</span>defaultSslContext<span style="color:#f92672">)</span>
				                              <span style="color:#f92672">.</span><span style="color:#a6e22e">addSniMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;*.test.com&#34;</span><span style="color:#f92672">,</span>
				                                      testDomainSpec <span style="color:#f92672">-&gt;</span> testDomainSpec<span style="color:#f92672">.</span><span style="color:#a6e22e">sslContext</span><span style="color:#f92672">(</span>testDomainSslContext<span style="color:#f92672">)))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<h1 id="59http访问日志">5.9.HTTP访问日志</h1>
<p>您可以以编程的方式或者配置的方式来启用<code>HTTP</code>访问日志。默认情况下，是禁用的</p>
<p>您可以通过设置<code>-Dreactor.netty.http.server.accessLogEnabled=true</code>配置来启用<code>HTTP</code>访问日志。</p>
<p>您可以使用下面的配置（用于Logback或类似的日志框架）来将<code>HTTP</code>访问日志单独分出来：</p>
<blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">&lt;</span>appender name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;accessLog&#34;</span> class<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ch.qos.logback.core.FileAppender&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;</span>file<span style="color:#f92672">&gt;</span>access_log<span style="color:#f92672">.</span><span style="color:#a6e22e">log</span><span style="color:#f92672">&lt;/</span>file<span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;</span>encoder<span style="color:#f92672">&gt;</span>
        <span style="color:#f92672">&lt;</span>pattern<span style="color:#f92672">&gt;%</span>msg<span style="color:#f92672">%</span>n<span style="color:#f92672">&lt;/</span>pattern<span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;/</span>encoder<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;/</span>appender<span style="color:#f92672">&gt;</span>
<span style="color:#f92672">&lt;</span>appender name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;async&#34;</span> class<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;ch.qos.logback.classic.AsyncAppender&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;</span>appender<span style="color:#f92672">-</span>ref ref<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;accessLog&#34;</span> <span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/</span>appender<span style="color:#f92672">&gt;</span>

<span style="color:#f92672">&lt;</span>logger name<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;reactor.netty.http.server.AccessLog&#34;</span> level<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;INFO&#34;</span> additivity<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">&gt;</span>
    <span style="color:#f92672">&lt;</span>appender<span style="color:#f92672">-</span>ref ref<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;async&#34;</span><span style="color:#f92672">/&gt;</span>
<span style="color:#f92672">&lt;/</span>logger<span style="color:#f92672">&gt;</span>
</code></pre></div></blockquote>
<p>下面的例子展示了以编程的方式开启<code>HTTP</code>访问日志：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/accessLog/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/accessLog/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">accessLog</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<p>这个方法的优先级高于配置系统参数。</p>
<p>默认情况下，日志格式是<a href="https://en.wikipedia.org/wiki/Common_Log_Format"target="_blank" rel="noopener noreferrer">Common Log Format</a>
，但是您可以通过参数来自定义格式，示例如下：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/accessLog/CustomLogAccessFormatApplication.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/accessLog/CustomLogAccessFormatApplication.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.logging.AccessLog<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomLogAccessFormatApplication</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">accessLog</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> x <span style="color:#f92672">-&gt;</span> AccessLog<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;method={}, uri={}&#34;</span><span style="color:#f92672">,</span> x<span style="color:#f92672">.</span><span style="color:#a6e22e">method</span><span style="color:#f92672">(),</span> x<span style="color:#f92672">.</span><span style="color:#a6e22e">uri</span><span style="color:#f92672">()))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<p>您也可以使用<code>AccessLogFactory#createFilter</code>方法来过滤<code>HTTP</code>访问日志，示例如下：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/accessLog/FilterLogAccessApplication.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/accessLog/FilterLogAccessApplication.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.logging.AccessLogFactory<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">FilterLogAccessApplication</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">accessLog</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> AccessLogFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">createFilter</span><span style="color:#f92672">(</span>p <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">!</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">uri</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/health/&#34;</span><span style="color:#f92672">)))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<p>请注意，这个方法也可以自定义格式，例如：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/accessLog/CustomFormatAndFilterAccessLogApplication.java.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/accessLog/CustomFormatAndFilterAccessLogApplication.java.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.logging.AccessLog<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.logging.AccessLogFactory<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomFormatAndFilterAccessLogApplication</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">accessLog</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> AccessLogFactory<span style="color:#f92672">.</span><span style="color:#a6e22e">createFilter</span><span style="color:#f92672">(</span>p <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">!</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>p<span style="color:#f92672">.</span><span style="color:#a6e22e">uri</span><span style="color:#f92672">()).</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/health/&#34;</span><span style="color:#f92672">),</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>						          x <span style="color:#f92672">-&gt;</span> AccessLog<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;method={}, uri={}&#34;</span><span style="color:#f92672">,</span> x<span style="color:#f92672">.</span><span style="color:#a6e22e">method</span><span style="color:#f92672">(),</span> x<span style="color:#f92672">.</span><span style="color:#a6e22e">uri</span><span style="color:#f92672">())))</span> <span style="color:#75715e">//&lt;2&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 指定要使用的过滤predicate</p>
<p>&lt;2&gt; 指定自定义日志格式</p>
</blockquote>
<h1 id="510http2">5.10.HTTP/2</h1>
<p>默认情况下，<code>HTTP</code>服务器支持<code>HTTP/1.1</code>。如果您需要<code>HTTP/2</code>，您可以通过配置来实现。除了协议配置外，如果您需要<code>H2</code>而不是<code>H2C</code>（<code>明文</code>）的话，还必须配置SSL。</p>
<blockquote>
<p>由于JDK8不支持 &ldquo;开箱即用 &ldquo;的应用层协议协商（ALPN）（尽管一些厂商将ALPN移植到JDK8），您需要添加额外的本地库依赖来支持它，例如：<a href="https://netty.io/wiki/forked-tomcat-native.html"target="_blank" rel="noopener noreferrer"><code>netty-tcnative-boringssl-static</code></a>
。</p>
</blockquote>
<p>下面列出了一个简单的<code>H2</code>的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/http2/H2Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/http2/H2Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> io.netty.handler.ssl.SslContextBuilder<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.HttpProtocol<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.io.File<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">H2Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		File cert <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;certificate.crt&#34;</span><span style="color:#f92672">);</span>
		File key <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> File<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;private.key&#34;</span><span style="color:#f92672">);</span>

		SslContextBuilder sslContextBuilder <span style="color:#f92672">=</span> SslContextBuilder<span style="color:#f92672">.</span><span style="color:#a6e22e">forServer</span><span style="color:#f92672">(</span>cert<span style="color:#f92672">,</span> key<span style="color:#f92672">);</span>

		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">port</span><span style="color:#f92672">(</span>8080<span style="color:#f92672">)</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">protocol</span><span style="color:#f92672">(</span>HttpProtocol<span style="color:#f92672">.</span><span style="color:#a6e22e">H2</span><span style="color:#f92672">)</span>                          <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">secure</span><span style="color:#f92672">(</span>spec <span style="color:#f92672">-&gt;</span> spec<span style="color:#f92672">.</span><span style="color:#a6e22e">sslContext</span><span style="color:#f92672">(</span>sslContextBuilder<span style="color:#f92672">))</span> <span style="color:#75715e">//&lt;2&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">handle</span><span style="color:#f92672">((</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">)))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 配置服务器仅支持<code>HTTP/2</code></p>
<p>&lt;2&gt; 配置<code>SSL</code></p>
</blockquote>
<p>现在该应用的表现应该像如下这样：</p>
<blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl --http2 https://localhost:8080 -i
HTTP/2 <span style="color:#ae81ff">200</span>

hello
</code></pre></div></blockquote>
<p>下面列出了一个简单的<code>H2C</code>的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/http2/H2CApplication.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/http2/H2CApplication.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.HttpProtocol<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">H2CApplication</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">port</span><span style="color:#f92672">(</span>8080<span style="color:#f92672">)</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">protocol</span><span style="color:#f92672">(</span>HttpProtocol<span style="color:#f92672">.</span><span style="color:#a6e22e">H2C</span><span style="color:#f92672">)</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">handle</span><span style="color:#f92672">((</span>request<span style="color:#f92672">,</span> response<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello&#34;</span><span style="color:#f92672">)))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<p>现在该应用的表现应该像如下这样：</p>
<blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ curl --http2-prior-knowledge http://localhost:8080 -i
HTTP/2 <span style="color:#ae81ff">200</span>

hello
</code></pre></div></blockquote>
<h2 id="5101选择协议">5.10.1.选择协议</h2>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-http/src/main/java/reactor/netty/http/HttpProtocol.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-http/src/main/java/reactor/netty/http/HttpProtocol.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> HttpProtocol <span style="color:#f92672">{</span>

	<span style="color:#75715e">/**
</span><span style="color:#75715e">	 * The default supported HTTP protocol by HttpServer and HttpClient
</span><span style="color:#75715e">	 */</span>
	HTTP11<span style="color:#f92672">,</span>

	<span style="color:#75715e">/**
</span><span style="color:#75715e">	 * HTTP/2.0 support with TLS
</span><span style="color:#75715e">	 * &lt;p&gt;If used along with HTTP/1.1 protocol, HTTP/2.0 will be the preferred protocol.
</span><span style="color:#75715e">	 * While negotiating the application level protocol, HTTP/2.0 or HTTP/1.1 can be chosen.
</span><span style="color:#75715e">	 * &lt;p&gt;If used without HTTP/1.1 protocol, HTTP/2.0 will always be offered as a protocol
</span><span style="color:#75715e">	 * for communication with no fallback to HTTP/1.1.
</span><span style="color:#75715e">	 */</span>
	H2<span style="color:#f92672">,</span>

	<span style="color:#75715e">/**
</span><span style="color:#75715e">	 * HTTP/2.0 support with clear-text.
</span><span style="color:#75715e">	 * &lt;p&gt;If used along with HTTP/1.1 protocol, will support H2C &#34;upgrade&#34;:
</span><span style="color:#75715e">	 * Request or consume requests as HTTP/1.1 first, looking for HTTP/2.0 headers
</span><span style="color:#75715e">	 * and {@literal Connection: Upgrade}. A server will typically reply a successful
</span><span style="color:#75715e">	 * 101 status if upgrade is successful or a fallback HTTP/1.1 response. When
</span><span style="color:#75715e">	 * successful the client will start sending HTTP/2.0 traffic.
</span><span style="color:#75715e">	 * &lt;p&gt;If used without HTTP/1.1 protocol, will support H2C &#34;prior-knowledge&#34;: Doesn&#39;t
</span><span style="color:#75715e">	 * require {@literal Connection: Upgrade} handshake between a client and server but
</span><span style="color:#75715e">	 * fallback to HTTP/1.1 will not be supported.
</span><span style="color:#75715e">	 */</span>
	H2C
<span style="color:#f92672">}</span>
</code></pre></div></blockquote>
<h1 id="511度量">5.11.度量</h1>
<p>HTTP服务器支持与<a href="https://micrometer.io/"target="_blank" rel="noopener noreferrer">Micrometer</a>
的内置集成。它暴露了所有前缀为<code>reactor.netty.http.server</code>的度量。</p>
<p>下面的表格提供了HTTP服务器度量的相关信息：</p>
<table>
<thead>
<tr>
<th>度量名称</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>reactor.netty.http.server.data.received</td>
<td>DistributionSummary</td>
<td>收到的数据量，以字节为单位</td>
</tr>
<tr>
<td>reactor.netty.http.server.data.sent</td>
<td>DistributionSummary</td>
<td>发送的数据量，以字节为单位</td>
</tr>
<tr>
<td>reactor.netty.http.server.errors</td>
<td>Counter</td>
<td>发生的错误数量</td>
</tr>
<tr>
<td>reactor.netty.http.server.data.received.time</td>
<td>Timer</td>
<td>消费传入的数据所花费的时间</td>
</tr>
<tr>
<td>reactor.netty.http.server.data.sent.time</td>
<td>Timer</td>
<td>传出数据所花费的时间</td>
</tr>
<tr>
<td>reactor.netty.http.server.response.time</td>
<td>Timer</td>
<td>请求/响应的总时间</td>
</tr>
</tbody>
</table>
<p>下面额外的度量也是可用的：</p>
<p><code>ByteBufAllocator</code>度量</p>
<table>
<thead>
<tr>
<th>度量名称</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>reactor.netty.bytebuf.allocator.used.heap.memory</td>
<td>Gauge</td>
<td>堆内存的字节数</td>
</tr>
<tr>
<td>reactor.netty.bytebuf.allocator.used.direct.memory</td>
<td>Gauge</td>
<td>堆外内存的字节数</td>
</tr>
<tr>
<td>reactor.netty.bytebuf.allocator.used.heap.arenas</td>
<td>Gauge</td>
<td>堆内存的个数（当使用<code>PooledByteBufAllocator</code>的时候）</td>
</tr>
<tr>
<td>reactor.netty.bytebuf.allocator.used.direct.arenas</td>
<td>Gauge</td>
<td>堆外内存的个数（当使用<code>PooledByteBufAllocator</code>的时候）</td>
</tr>
<tr>
<td>reactor.netty.bytebuf.allocator.used.threadlocal.caches</td>
<td>Gauge</td>
<td>threadlocal的缓存数量（当使用<code>PooledByteBufAllocator</code>的时候）</td>
</tr>
<tr>
<td>reactor.netty.bytebuf.allocator.used.tiny.cache.size</td>
<td>Gauge</td>
<td>微小缓存的大小（当使用<code>PooledByteBufAllocator</code>的时候）</td>
</tr>
<tr>
<td>reactor.netty.bytebuf.allocator.used.small.cache.size</td>
<td>Gauge</td>
<td>小缓存的大小（当使用<code>PooledByteBufAllocator</code>的时候）</td>
</tr>
<tr>
<td>reactor.netty.bytebuf.allocator.used.normal.cache.size</td>
<td>Gauge</td>
<td>一般缓存的大小（当使用<code>PooledByteBufAllocator</code>的时候）</td>
</tr>
<tr>
<td>reactor.netty.bytebuf.allocator.used.chunk.size</td>
<td>Gauge</td>
<td>一个区域的块大小（当使用<code>PooledByteBufAllocator</code>的时候）</td>
</tr>
</tbody>
</table>
<p>下面是开启集成的度量的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/metrics/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/metrics/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> io.micrometer.core.instrument.Metrics<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> io.micrometer.core.instrument.config.MeterFilter<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		Metrics<span style="color:#f92672">.</span><span style="color:#a6e22e">globalRegistry</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>		       <span style="color:#f92672">.</span><span style="color:#a6e22e">config</span><span style="color:#f92672">()</span>
		       <span style="color:#f92672">.</span><span style="color:#a6e22e">meterFilter</span><span style="color:#f92672">(</span>MeterFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">maximumAllowableTags</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;reactor.netty.http.server&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;URI&#34;</span><span style="color:#f92672">,</span> 100<span style="color:#f92672">,</span> MeterFilter<span style="color:#f92672">.</span><span style="color:#a6e22e">deny</span><span style="color:#f92672">()));</span>

		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">metrics</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> s <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
				              <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/stream/&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span> <span style="color:#75715e">//&lt;2&gt;
</span><span style="color:#75715e"></span>				                  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;/stream/{n}&#34;</span><span style="color:#f92672">;</span>
				              <span style="color:#f92672">}</span>
				              <span style="color:#66d9ef">else</span> <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>s<span style="color:#f92672">.</span><span style="color:#a6e22e">startsWith</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bytes/&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
				                  <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;/bytes/{n}&#34;</span><span style="color:#f92672">;</span>
				              <span style="color:#f92672">}</span>
				              <span style="color:#66d9ef">return</span> s<span style="color:#f92672">;</span>
				          <span style="color:#f92672">})</span> <span style="color:#75715e">//&lt;3&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">route</span><span style="color:#f92672">(</span>r <span style="color:#f92672">-&gt;</span>
				              r<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/stream/{n}&#34;</span><span style="color:#f92672">,</span>
				                   <span style="color:#f92672">(</span>req<span style="color:#f92672">,</span> res<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> res<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>req<span style="color:#f92672">.</span><span style="color:#a6e22e">param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;n&#34;</span><span style="color:#f92672">))))</span>
				               <span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bytes/{n}&#34;</span><span style="color:#f92672">,</span>
				                   <span style="color:#f92672">(</span>req<span style="color:#f92672">,</span> res<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> res<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>req<span style="color:#f92672">.</span><span style="color:#a6e22e">param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;n&#34;</span><span style="color:#f92672">)))))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 设置带有<code>URI</code>标签的仪表的上限</p>
<p>&lt;2&gt; 在可能的情况下，模板化的URI将被用作URI标签的值。</p>
<p>&lt;3&gt; 启用内置集成的Micrometer</p>
</blockquote>
<blockquote>
<p>为了避免启用度量而造成的内存和CPU的开销，如果可以的话，将真实的URI转换为模板化的URI是很重要的。如果不转换为类似于模板的形式，则会导致每一个不同的URI都会创建一个不同的标签，这样度量会占用大量的内存。</p>
</blockquote>
<blockquote>
<p>始终对带有URI标签的仪表设置一个上限。给仪表配置一个上线以防真实的URI不能被模板化。您可以在<a href="https://micrometer.io/docs/concepts#_denyaccept_meters"target="_blank" rel="noopener noreferrer"><code>maximumAllowableTags</code></a>
找更多的信息。</p>
</blockquote>
<p>如果您想让HTTP服务端度量与除了<code>Micrometer</code>之外的系统集成或者想提供自己与<code>Micrometer</code>的集成来添加自己的度量记录器，您可以按如下方式实现：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/metrics/custom/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/metrics/custom/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> reactor.core.publisher.Mono<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.channel.ChannelMetricsRecorder<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#f92672">import</span> java.net.SocketAddress<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.time.Duration<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">metrics</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">,</span> CustomHttpServerMetricsRecorder<span style="color:#f92672">::</span><span style="color:#66d9ef">new</span><span style="color:#f92672">)</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">route</span><span style="color:#f92672">(</span>r <span style="color:#f92672">-&gt;</span>
				              r<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/stream/{n}&#34;</span><span style="color:#f92672">,</span>
				                   <span style="color:#f92672">(</span>req<span style="color:#f92672">,</span> res<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> res<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>req<span style="color:#f92672">.</span><span style="color:#a6e22e">param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;n&#34;</span><span style="color:#f92672">))))</span>
				               <span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/bytes/{n}&#34;</span><span style="color:#f92672">,</span>
				                   <span style="color:#f92672">(</span>req<span style="color:#f92672">,</span> res<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> res<span style="color:#f92672">.</span><span style="color:#a6e22e">sendString</span><span style="color:#f92672">(</span>Mono<span style="color:#f92672">.</span><span style="color:#a6e22e">just</span><span style="color:#f92672">(</span>req<span style="color:#f92672">.</span><span style="color:#a6e22e">param</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;n&#34;</span><span style="color:#f92672">)))))</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>

<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 开启HTTP服务端度量并且提供<a href="https://projectreactor.io/docs/netty/release/api/reactor/netty/http/server/HttpServerMetricsRecorder.html"target="_blank" rel="noopener noreferrer"><code>HttpServerMetricsRecorder</code></a>
的实现。</p>
</blockquote>
<h1 id="512unix域套接字">5.12.Unix域套接字</h1>
<p>当使用本地传输时，<code>HTTP</code>服务器支持Unix域套接字（UDS）。</p>
<p>下面是使用UDS的例子：</p>
<blockquote>
<p><a href="https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/uds/Application.java">https://github.com/reactor/reactor-netty/blob/master/reactor-netty-examples/src/main/java/reactor/netty/examples/documentation/http/server/uds/Application.java</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> io.netty.channel.unix.DomainSocketAddress<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.DisposableServer<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> reactor.netty.http.server.HttpServer<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Application</span> <span style="color:#f92672">{</span>

	<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
		DisposableServer server <span style="color:#f92672">=</span>
				HttpServer<span style="color:#f92672">.</span><span style="color:#a6e22e">create</span><span style="color:#f92672">()</span>
				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindAddress</span><span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">new</span> DomainSocketAddress<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/tmp/test.sock&#34;</span><span style="color:#f92672">))</span> <span style="color:#75715e">//&lt;1&gt;
</span><span style="color:#75715e"></span>				          <span style="color:#f92672">.</span><span style="color:#a6e22e">bindNow</span><span style="color:#f92672">();</span>

		server<span style="color:#f92672">.</span><span style="color:#a6e22e">onDispose</span><span style="color:#f92672">()</span>
		      <span style="color:#f92672">.</span><span style="color:#a6e22e">block</span><span style="color:#f92672">();</span>
	<span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>&lt;1&gt; 指定将使用的<code>DomainSocketAddress</code></p>
</blockquote>
<p><a href="https://github.com/reactor/reactor-netty/edit/master/docs/asciidoc/http-server.adoc"target="_blank" rel="noopener noreferrer">Suggest Edit</a>
 to &ldquo;<a href="https://projectreactor.io/docs/netty/release/reference/index.html#http-server"target="_blank" rel="noopener noreferrer">HTTP Server</a>
&rdquo;</p>
<hr>
<h2 id="reactor-netty参考指南目录contents-1"><a href="../contents">Reactor Netty参考指南目录</a>
</h2></article><section class="article labels"><a class="category" href=/categories/%E7%BF%BB%E8%AF%91/>翻译</a><a class="tag" href=/tags/reactor-netty/>reactor netty</a></section><section class="article license">版权声明：如需转载，请带上本文链接、注明来源和本声明。否则将追究法律责任。https://www.immuthex.com/posts/reactor-netty-reference-guide/http-server</section><section class="article author"><div class="details"><a class="item" href="https://github.com/immuthex" target="_blank" rel="noopener noreferrer"><span class="iconfont icon-github"></span>&nbsp;immuthex</a></div>
</section>
</div>
<div class="article bottom"><section class="article navigation"><p><a class="link" href="/posts/reactor-netty-reference-guide/http-client/"><span class="iconfont icon-article"></span>Reactor Netty参考指南 - 6.HTTP客户端</a></p><p><a class="link" href="/posts/reactor-netty-reference-guide/tcp-client/"><span class="iconfont icon-article"></span>Reactor Netty参考指南 - 4.TCP客户端</a></p></section></div></section><section id="footer"><div class="footer-wrap">
    <p class="copyright">©2021 immuthex</p></div>
</section></body>

</html>